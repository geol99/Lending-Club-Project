---
title: "LendingClubLoanDefaultClassification"
author: "Vikas Pulpa"
date: "`r Sys.Date()`"
output: html_document
---

```{r Load Packages}

if(!require(tidyverse))
{
  install.packages('tidyverse');
}

if(!require(car))
{
  install.packages('car');
}

if(!require(nortest))
{
  install.packages('nortest');
}

if(!require(MASS))
{
  install.packages('MASS');
}

if(!require(ggplot2))
{
  install.packages('ggplot2');
}

if(!require(caret))
{
  install.packages('caret');
}

if(!require(caret))
{
  install.packages('caret');
}

if(!require(corrplot))
{
  install.packages('corrplot');
}

if(!require(e1071))
{
  install.packages('e1071');
}

if(!require(readr))
{
  install.packages('readr');
}

if(!require(reshape2))
{
  install.packages('reshape2');
}

if(!require(skimr))
{
  install.packages('skimr');
}

if(!require(stringr))
{
  install.packages('stringr');
}

if(!require(rstatix))
{
  install.packages('rstatix');
}

require(tidyverse)
require(car)
require(nortest)
require(MASS)
require(ggplot2)
require(caret)
require(corrplot)
require(e1071)
require(readr)
require(dplyr)
require(reshape2)
require(skimr)
require(stringr)
require(rstatix)

```


#### **1. Read the csv into a tibble data structure**


```{r read csv into Tibble}
lendingClubData  <- read_csv("C:\\Users\\vipulpa\\OneDrive - Microsoft\\StatisticsMasters\\STAT656\\Homework\\Project\\Task3\\Data\\LoanStats3a.csv")
```

#### **2. Looking at the data parsing issues and cleaning up the excel file**

```{r look at the parsing issues}
problems(lendingClubData)
```

On examining the excel sheet, we observed that the lines 39788 and 39789 were blank except that it indicates the subsequent rows indicate that loan where granted out of policy.

Therefore, we edited the excel to:

* Deleted those two rows 39788 and 39789 from excel.
* Added a new feature IsLoanMeetsPolicy that takes value of 'Yes' for the loans that meet the policy (first 39786 rows) and 'No' for the ones that don't.

#### **3. Read the new csv into a tibble data structure**

```{r Reading the new csv into Tibble}
lendingClubData  <- read_csv("C:\\Users\\vipulpa\\OneDrive - Microsoft\\StatisticsMasters\\STAT656\\Homework\\Project\\Task3\\Data\\LoanStats3aCleaned.csv")
```

#### **4. Explore the Data **

```{r Explore Lending Club Data}
dim(lendingClubData)
#lendingClubData
```

#### **5. Data Pre-Processing **


##### **5. a. Look at the data structures **

```{r Checking data types 2}
table(sapply(lendingClubData[1,],class))
```

##### **5. b. Look at the missing values and perform Featurewise imputation **

```{r function ggplot_missing}

ggplot_missing <- function(x){

	#### This function produces a plot of the missing data pattern in x.  It is a modified version of a function in the 'neato' package
  
  my_colors <- RColorBrewer::brewer.pal(12, "Paired")[6:7]
  
  x %>% 
    is.na %>%
    melt %>%
    ggplot(data = ., aes(x = Var2, y = Var1)) +
      geom_raster(aes(fill = value)) +
      #scale_fill_brewer(name = "", labels = c("Present","Missing"), palette="Paired", direction = -1) +
      scale_fill_manual(name = "", labels = c("Present","Missing"), values = c(my_colors[2], my_colors[1])) +
      theme_minimal() + 
      theme(axis.text.x  = element_text(angle=45, vjust=0.5)) + 
      labs(x = "Variables in Dataset", y = "Rows / observations")
}
ggplot_missing(lendingClubData %>% dplyr::select(-loan_status))
```

```{r find the columns which has more than 50% missing values}
#sapply(lendingClubData, function(x){ sum(is.na(x))*100./nrow(lendingClubData) })
sapply(lendingClubData, function(x){ sum(is.na(x))*100./nrow(lendingClubData) }) 

missingValues <- rep(0, 5)
for(i in 1:5) {
  missingValues[i] <-  sum(ifelse(sapply(lendingClubData, function(x){ sum(is.na(x))*100./nrow(lendingClubData) }) <= i * 10.0 , 1, 0))
}
```

```{r % of missing values}
PercentageOfNullValues <- c('10 % or less', '20 % or less', '30 % or less', '40 % or less', '50 % or less')
(missingValueColumns <- data.frame (PercentageOfNullValues, missingValues))

columnVector <- ifelse(sapply(lendingClubData, function(x){ sum(is.na(x))*100./nrow(lendingClubData) }) <= 50.0 , 1, 0)
table(columnVector)
```


```{r remove the columns that has more than 50% of the data missing}
lendingClubDataReduced <- lendingClubData %>% select_if(columnVector == 1)
dim(lendingClubDataReduced)
ggplot_missing(lendingClubDataReduced)
```

##### **5. c. Remove the unnecessary columns based on the row count **

```{r Checking data types again}
table(sapply(lendingClubDataReduced[1, ], class))

numericColumns   <- names(lendingClubDataReduced) [sapply(lendingClubDataReduced[1, ], class) == "numeric"]
characterColumns <- names(lendingClubDataReduced) [sapply(lendingClubDataReduced[1, ], class) == "character"]
logicalColumns   <- names(lendingClubDataReduced) [sapply(lendingClubDataReduced[1, ], class) == "logical"]
```


```{r remove unnecessary CHARACTER columns}
sapply(lendingClubDataReduced[, characterColumns], function(x) {length(unique(x))})

#lendingClubDataReduced <- lendingClubDataReduced %>%
#                           dplyr::select( - c(
#                                                 emp_title, verification_status, pymnt_plan, url, desc, title, zip_code, addr_state
#                                                 , last_pymnt_d, application_type
#                                              )
#                                        )

lendingClubDataReduced <- lendingClubDataReduced %>%
                           dplyr::select( - c(
                                                 emp_title, verification_status, pymnt_plan, url, desc, title, zip_code
                                                 , last_pymnt_d, application_type
                                              )
                                        )
```

```{r remove unnecessary Numeric columns}
sapply(lendingClubDataReduced[, numericColumns], function(x) {length(unique(x))})

lendingClubDataReduced <- lendingClubDataReduced %>%
                           dplyr::select( - c(id, member_id, policy_code ) )

#'acc_now_delinq','chargeoff_within_12_mths','collection_recovery_fee', 'collections_12_mths_ex_med','delinq_amnt','policy_code','tax_liens'
```

```{r remove unnecessary LOGICAL columns}
sapply(lendingClubDataReduced[, logicalColumns], function(x) {length(unique(x))})

lendingClubDataReduced <- lendingClubDataReduced %>%
                           dplyr::select( - c(initial_list_status) )

```

```{r look at number of remaining columns again}
dim(lendingClubDataReduced)
```

##### **5. d. Remove the unnecessary columns after looking at the data dictionary **

The following features are not required since we are classifying the risk of default before the loan is funded.
*Note, we will keep installment to see if the user defaults for the given installment.

* funded_amnt
* funded_amnt_inv
* int_rate
* issue_d
* out_prncp
* out_prncp_inv
* total_pymnt
* total_pymnt_inv
* total_rec_prncp
* total_rec_int
* total_rec_late_fee
* recoveries
* collection_recovery_fee
* last_pymnt_amnt
* last_credit_pull_d
* last_pymnt_d
* next_pymnt_d


```{r Deleting information not known at the time of loan origination.}
#featureList              <- c(
#                               'funded_amnt',              'funded_amnt_inv', 'int_rate',           'issue_d',       'out_prncp',          'out_prncp_inv'
#                               ,'total_pymnt',             'total_pymnt_inv', 'total_rec_prncp',    'total_rec_int', 'total_rec_late_fee', 'recoveries'
#                               ,'collection_recovery_fee', 'last_pymnt_amnt', 'last_credit_pull_d'
#                             )

featureList              <- c(
                                'funded_amnt',             'funded_amnt_inv', 'int_rate',           'issue_d',       'out_prncp',          'out_prncp_inv'
                               ,'total_pymnt',             'total_pymnt_inv', 'total_rec_prncp',    'total_rec_int', 'total_rec_late_fee', 'recoveries'
                               ,'collection_recovery_fee', 'last_pymnt_amnt'
                             )

lendingClubDataReduced   <- lendingClubDataReduced %>% dplyr::select(-all_of(featureList))
```

```{r look at number of remaining columns again}
dim(lendingClubDataReduced)
names(lendingClubDataReduced)
```

```{r Remove Numeric Columns whose sum is 0}

lendingClubDataReducedNumeric <- lendingClubDataReduced[,sapply(lendingClubDataReduced, class) != 'character']
zeroSumColumns <- colnames(lendingClubDataReducedNumeric[,colSums(lendingClubDataReducedNumeric,na.rm = TRUE)==0])
zeroSumColumns

lendingClubDataReduced <- lendingClubDataReduced %>%
                            dplyr::select(-all_of(zeroSumColumns))
```

```{r look at number of remaining columns once again}
dim(lendingClubDataReduced)
names(lendingClubDataReduced)
```


```{r Checking data types}
table(sapply(lendingClubDataReduced[1, ], class))

numericColumns   <- names(lendingClubDataReduced) [sapply(lendingClubDataReduced[1, ], class) == "numeric"]
characterColumns <- names(lendingClubDataReduced) [sapply(lendingClubDataReduced[1, ], class) == "character"]
```


```{r look at number of remaining columns}
numericColumns
characterColumns
```

##### **5. e. Variable Cleanup **

```{r Looking at individual features}
lendingClubDataReduced %>% group_by(term) %>%  summarise(Count = n())
lendingClubDataReduced %>% group_by(grade) %>%  summarise(Count = n())
lendingClubDataReduced %>% group_by(sub_grade) %>%  summarise(Count = n())
lendingClubDataReduced %>% group_by(emp_length) %>%  summarise(Count = n())
lendingClubDataReduced %>% group_by(home_ownership) %>%  summarise(Count = n())
lendingClubDataReduced %>% group_by(loan_status) %>%  summarise(Count = n())
lendingClubDataReduced %>% group_by(purpose) %>%  summarise(Count = n())
lendingClubDataReduced %>% group_by(addr_state) %>%  summarise(Count = n())
lendingClubDataReduced %>% group_by(earliest_cr_line) %>%  summarise(Count = n())
lendingClubDataReduced %>% group_by(revol_util) %>%  summarise(Count = n())
lendingClubDataReduced %>% group_by(last_credit_pull_d) %>%  summarise(Count = n())
lendingClubDataReduced %>% group_by(IsLoanMeetsPolicy) %>%  summarise(Count = n())
```

```{r Look For NA's in Character Columns}

lendingClubDataReduced %>% 
  group_by(term) %>% 
  dplyr::filter(is.na(term) | term == "N/A"  | term == "n/a") %>%  
  summarise(Count = n())

lendingClubDataReduced %>% 
  group_by(grade) %>% 
  dplyr::filter(is.na(grade)| grade == "N/A" | grade == "n/a") %>%  
  summarise(Count = n())

lendingClubDataReduced %>% 
  group_by(sub_grade)  %>% 
  dplyr::filter(is.na(sub_grade) | sub_grade == "N/A" | sub_grade == "n/a") %>%  
  summarise(Count = n())

lendingClubDataReduced %>% 
  group_by(emp_length) %>% 
  dplyr::filter(is.na(emp_length) | emp_length == "N/A" | emp_length == "n/a") %>%  
  summarise(Count = n())

lendingClubDataReduced %>% 
  group_by(home_ownership) %>% 
  dplyr::filter(is.na(home_ownership) | home_ownership == "N/A" | home_ownership == "n/a") %>%  
  summarise(Count = n())

lendingClubDataReduced %>% 
  group_by(loan_status) %>% 
  dplyr::filter(is.na(loan_status) | loan_status == "N/A" | loan_status == "n/a") %>%  
  summarise(Count = n())

lendingClubDataReduced %>% 
  group_by(purpose) %>% 
  dplyr::filter(is.na(purpose) | purpose == "N/A" | purpose == "n/a") %>%  
  summarise(Count = n())

lendingClubDataReduced %>%
  group_by(addr_state) %>% 
  dplyr::filter(is.na(addr_state) | addr_state == "N/A" | addr_state == "n/a") %>%  
  summarise(Count = n())

lendingClubDataReduced %>% 
  group_by(earliest_cr_line) %>% 
  dplyr::filter(is.na(earliest_cr_line) | earliest_cr_line == "N/A" | earliest_cr_line == "n/a") %>%  
  summarise(Count = n())

lendingClubDataReduced %>% 
  group_by(revol_util) %>% 
  dplyr::filter(is.na(revol_util) | revol_util == "N/A" | revol_util == "n/a") %>%  
  summarise(Count = n())

lendingClubDataReduced %>% 
  group_by(last_credit_pull_d) %>% 
  dplyr::filter(is.na(last_credit_pull_d) | last_credit_pull_d == "N/A" | last_credit_pull_d == "n/a") %>%  
  summarise(Count = n())

lendingClubDataReduced %>% 
  group_by(IsLoanMeetsPolicy) %>% 
  dplyr::filter(is.na(sub_grade)) %>%  
  summarise(Count = n())

```
The following columns have wrong date format. Therefore removing them:
* earliest_cr_line
* last_credit_pull_d


```{r Character Variable Cleanup}
lendingClubDataReduced  <- lendingClubDataReduced %>% dplyr::select(-c(earliest_cr_line, last_credit_pull_d))
```

Note: To be Revisited. We will look at the variable importance and make the decision to filter out data.
      For now filtering out the data.

* Can we remove home_ownership IN (NONE, OTHER)

```{r Looking at home_ownership & Data Filtering (Character Columns) }

lendingClubDataReduced %>% dplyr::filter(home_ownership %in% c("NONE", "OTHER"))

#lendingClubDataFiltered <- lendingClubDataReduced %>% dplyr::filter(!is.na(revol_util))
#lendingClubDataFiltered <- lendingClubDataFiltered %>% dplyr::filter(!is.na(last_credit_pull_d))

#lendingClubDataFiltered %>% group_by(earliest_cr_line)   %>% dplyr::filter(is.na(earliest_cr_line))   %>%  summarise(Count = n())
#lendingClubDataFiltered %>% group_by(revol_util)         %>% dplyr::filter(is.na(revol_util))         %>%  summarise(Count = n())
#lendingClubDataFiltered %>% group_by(last_credit_pull_d) %>% dplyr::filter(is.na(last_credit_pull_d)) %>%  summarise(Count = n())

dim(lendingClubDataReduced)
ggplot_missing(lendingClubDataReduced)

```
##### **5. f. Datatype Formatting & Conversion **

1. The following columns have wrong date format. Therefore removing them:
* earliest_cr_line
* last_credit_pull_d

2. Format:
*  term
*  loan_status
*  revol_util
*  emp_length

```{r Character Variable Formatting & Conversion}

lendingClubDataCleaned  <- lendingClubDataReduced %>% 
                              mutate(term = str_replace(term, "months", "")) %>% 
                              mutate_at("term", as.numeric) %>% 
                              mutate(loan_status = str_replace(loan_status, "Does not meet the credit policy. Status:", "")) %>% 
                              mutate(emp_length = str_replace_all(
                                                                  emp_length, 
                                                                  c('< 1 year' = '0 years' , '10\\+ years' = '10 years', "n/a" = NA, "years" = "", "year" = "")                                                                   )
                                     ) %>%
                              mutate_at("emp_length", as.numeric) %>%
                              #mutate(earliest_cr_line = as.Date(earliest_cr_line, format='%d/%m/%Y')) %>% 
                              mutate(revol_util = str_replace(revol_util, "%", "")) %>% 
                              mutate_at("revol_util", as.numeric)
                              #mutate(last_credit_pull_d = as.Date(last_credit_pull_d, format='%d/%m/%Y')) 

```

Note: To be Revisited. We will look at the variable importance and make the decision to filter out data.
      For now imputing the data.

* Can we remove/impute rows with is.na(emp_length)
* Can we remove/impute rows with is.na(revol_util)


```{r Checking data types again}
table(sapply(lendingClubDataCleaned[1, ], class))

numericColumns   <- names(lendingClubDataCleaned) [sapply(lendingClubDataCleaned[1, ], class) == "numeric"]
characterColumns <- names(lendingClubDataCleaned) [sapply(lendingClubDataCleaned[1, ], class) == "character"]

```


```{r look at number of remaining columns again}
numericColumns
characterColumns
```

##### **5. g. Numeric Features Imputation **

```{r Look For NA's in Numeric Columns}

rbind(
 lendingClubDataCleaned %>%  mutate(ColumnName = "loan_amnt")              %>% dplyr::filter(is.na(loan_amnt))             %>%  
                               group_by(ColumnName)  %>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "term")              %>% dplyr::filter(is.na(term))                       %>%  
                               group_by(term)        %>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "installment")            %>% dplyr::filter(is.na(installment))           %>%  
                               group_by(ColumnName)  %>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "emp_length")             %>% dplyr::filter(is.na(emp_length))            %>%  
                               group_by(ColumnName)  %>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "annual_inc")             %>% dplyr::filter(is.na(annual_inc))            %>%  
                                group_by(ColumnName)%>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "dti")                    %>% dplyr::filter(is.na(dti))                   %>%  
                                group_by(ColumnName)%>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "delinq_2yrs")            %>% dplyr::filter(is.na(delinq_2yrs))           %>%  
                                group_by(ColumnName)%>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "inq_last_6mths")         %>% dplyr::filter(is.na(inq_last_6mths))        %>%  
                                group_by(ColumnName)%>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "open_acc")               %>% dplyr::filter(is.na(open_acc))              %>%  
                                group_by(ColumnName)%>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "pub_rec")                %>% dplyr::filter(is.na(pub_rec))               %>%  
                                group_by(ColumnName)%>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "revol_bal")              %>% dplyr::filter(is.na(revol_bal))             %>%  
                                group_by(ColumnName)%>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "revol_util")             %>% dplyr::filter(is.na(revol_util))            %>%  
                                group_by(ColumnName)%>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "total_acc")              %>% dplyr::filter(is.na(total_acc))             %>%  
                                group_by(ColumnName)%>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "acc_now_delinq")         %>% dplyr::filter(is.na(acc_now_delinq))        %>%  
                                group_by(ColumnName)%>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "delinq_amnt")            %>% dplyr::filter(is.na(delinq_amnt))           %>%  
                                group_by(ColumnName)%>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "pub_rec_bankruptcies")   %>% dplyr::filter(is.na(pub_rec_bankruptcies))  %>%  
                                group_by(ColumnName)%>%  summarise(Count = n()),
 lendingClubDataCleaned %>%  mutate(ColumnName = "tax_liens")              %>% dplyr::filter(is.na(tax_liens))             %>%  
                               group_by(ColumnName)%>%  summarise(Count = n())
)
```
```{r % of Missing Values}
missingValueColumns <- data.frame(sapply(lendingClubDataCleaned, function(x){ sum(is.na(x))*100./nrow(lendingClubData) }))
missingValueColumns <- cbind(variable = row.names(missingValueColumns), missingValueColumns)

names(missingValueColumns) <- c("MissingValueColumn", "MissingValuePercent")
missingValueColumns %>% 
  dplyr::filter(MissingValuePercent != 0) %>% 
  arrange(desc(MissingValuePercent))
```

```{r Looking at Numeric Columns having N/As }
lendingClubDataCleaned %>% group_by(pub_rec_bankruptcies )  %>%  summarise(Count = n())
lendingClubDataCleaned %>% group_by(emp_length)             %>%  summarise(Count = n())
lendingClubDataCleaned %>% group_by(tax_liens)              %>%  summarise(Count = n())
lendingClubDataCleaned %>% group_by(revol_util)             %>%  summarise(Count = n())
lendingClubDataCleaned %>% group_by(delinq_2yrs)            %>%  summarise(Count = n())
lendingClubDataCleaned %>% group_by(inq_last_6mths)         %>%  summarise(Count = n())
lendingClubDataCleaned %>% group_by(open_acc)               %>%  summarise(Count = n())
lendingClubDataCleaned %>% group_by(pub_rec)                %>%  summarise(Count = n())
lendingClubDataCleaned %>% group_by(total_acc)              %>%  summarise(Count = n())
lendingClubDataCleaned %>% group_by(acc_now_delinq)         %>%  summarise(Count = n())
lendingClubDataCleaned %>% group_by(delinq_amnt)            %>%  summarise(Count = n())
lendingClubDataCleaned %>% group_by(annual_inc)             %>%  summarise(Count = n())
```

Note: To be Revisited. We will look at the variable importance and make the decision to filter out data.
      For now defaulting(Imputing) them to 0.


For the following columns NA might indicate that the data entry operator might have inputted nothing or there is not value to be entered for the applicant.

* pub_rec_bankruptcies has only 3 values {0, 1, 2} with most of the values 0.
* tax_liens has only 2 values {0, 1} with most of the values 0.
* delinq_2yrs.
* inq_last_6mths
* pub_rec
* acc_now_delinq has only 3 values {0, 1} with most of the values 0.
* delinq_amnt

Therefore replacing NA with 0


```{r Data Imputation: Replacing NA with 0}
lendingClubDataImputed <- lendingClubDataCleaned %>% 
                            mutate(pub_rec_bankruptcies = if_else(is.na(pub_rec_bankruptcies), 0, pub_rec_bankruptcies)) %>%
                            mutate(tax_liens = if_else(is.na(tax_liens), 0, tax_liens)) %>%
                            mutate(delinq_2yrs = if_else(is.na(delinq_2yrs), 0, delinq_2yrs)) %>%
                            mutate(inq_last_6mths = if_else(is.na(inq_last_6mths), 0, inq_last_6mths)) %>%
                            mutate(pub_rec = if_else(is.na(pub_rec), 0, pub_rec)) %>%
                            mutate(acc_now_delinq = if_else(is.na(acc_now_delinq), 0, acc_now_delinq)) %>%
                            mutate(delinq_amnt = if_else(is.na(delinq_amnt), 0, acc_now_delinq))
```

Performing the mean/medain/mode/quantile imputation for the following columns:

* emp_length
* revol_util
* open_acc
* total_acc
* annual_inc

```{r Data Imputation: emp_length - First Quantile Imputation) }

summary(lendingClubDataImputed$emp_length)
quantile(lendingClubDataImputed$emp_length, na.rm = TRUE)

boxplot(lendingClubDataImputed$emp_length)
plot(density(lendingClubDataImputed$emp_length[!is.na(lendingClubDataImputed$emp_length)], bw = "nrd"))


lendingClubDataImputed <- lendingClubDataImputed %>%
                            mutate(emp_length = if_else(is.na(emp_length), quantile(emp_length, na.rm = TRUE)[2] , emp_length))

points(density(lendingClubDataImputed$emp_length[!is.na(lendingClubDataImputed$emp_length)], bw = "nrd"), type = "l", col = "maroon")

```

```{r Data Imputation: revol_util - Mean Imputation) }

summary(lendingClubDataImputed$revol_util)
quantile(lendingClubDataImputed$revol_util, na.rm = TRUE)

boxplot(lendingClubDataImputed$revol_util)
plot(density(lendingClubDataImputed$revol_util[!is.na(lendingClubDataImputed$revol_util)], bw = "nrd"))


lendingClubDataImputed <- lendingClubDataImputed %>%
                           mutate(revol_util = if_else(is.na(revol_util), mean(revol_util, na.rm = TRUE) , revol_util))

points(density(lendingClubDataImputed$revol_util[!is.na(lendingClubDataImputed$revol_util)], bw = "nrd"), type = "l", col = "maroon")

```

```{r Data Imputation: open_acc - Median Imputation) }

summary(lendingClubDataImputed$open_acc)
quantile(lendingClubDataImputed$open_acc, na.rm = TRUE)

boxplot(lendingClubDataImputed$open_acc)
plot(density(lendingClubDataImputed$open_acc[!is.na(lendingClubDataImputed$open_acc)], bw = "nrd"))


lendingClubDataImputed <- lendingClubDataImputed %>%
                           mutate(open_acc = if_else(is.na(open_acc), median(open_acc, na.rm = TRUE) , open_acc))

points(density(lendingClubDataImputed$open_acc[!is.na(lendingClubDataImputed$open_acc)], bw = "nrd"), type = "l", col = "maroon")

```
```{r Data Imputation: total_acc - median Imputation) }

summary(lendingClubDataImputed$total_acc)
quantile(lendingClubDataImputed$total_acc, na.rm = TRUE)

boxplot(lendingClubDataImputed$total_acc)
plot(density(lendingClubDataImputed$total_acc[!is.na(lendingClubDataImputed$total_acc)], bw = "nrd"))


lendingClubDataImputed <- lendingClubDataImputed %>%
                           mutate(total_acc = if_else(is.na(total_acc), median(total_acc, na.rm = TRUE) , total_acc))

points(density(lendingClubDataImputed$total_acc[!is.na(lendingClubDataImputed$total_acc)], bw = "nrd"), type = "l", col = "maroon")

```

```{r Data Imputation: annual_inc - Median Imputation) }

summary(lendingClubDataImputed$annual_inc)
quantile(lendingClubDataImputed$annual_inc, na.rm = TRUE)

boxplot(lendingClubDataImputed$annual_inc)
plot(density(lendingClubDataImputed$annual_inc[!is.na(lendingClubDataImputed$annual_inc)], bw = "nrd"))


lendingClubDataImputed <- lendingClubDataImputed %>%
                           mutate(annual_inc = if_else(is.na(annual_inc), median(annual_inc, na.rm = TRUE) , annual_inc))

points(density(lendingClubDataImputed$annual_inc[!is.na(lendingClubDataImputed$annual_inc)], bw = "nrd"), type = "l", col = "maroon")

```

```{r Looking at missing values once again}
dim(lendingClubDataImputed)
ggplot_missing(lendingClubDataImputed)
```
##### **6. Univariate Analysis **

##### **6. a. Looking at feature that have low SD **

```{r Summary Statistics}
skim(lendingClubDataImputed)
```
```{r Looking at variables that have low SD}
lendingClubDataImputed %>% group_by(delinq_2yrs) %>% summarise(Count = n())
lendingClubDataImputed %>% group_by(pub_rec) %>% summarise(Count = n())
lendingClubDataImputed %>% group_by(acc_now_delinq) %>% summarise(Count = n())
lendingClubDataImputed %>% group_by(delinq_amnt) %>% summarise(Count = n())
lendingClubDataImputed %>% group_by(pub_rec_bankruptcies) %>% summarise(Count = n())
lendingClubDataImputed %>% group_by(tax_liens) %>% summarise(Count = n())
```
Further below, we are going to remove the features that do not add value to the supervisor.

##### **6. b. Looking at relationship between feature and supervisor and also the features that have low SD **

Filtering the data so that we have only "Charged Off" and "Fully Paid" loan statuses.
The rest of the loan statuses does not help in classification.

```{r lendingClubDataImputed}
lendingClubDataFiltered <- lendingClubDataImputed %>% dplyr::filter(loan_status %in% c("Charged Off", "Fully Paid"))
names(lendingClubDataFiltered)
attach(lendingClubDataFiltered)
```

```{r BoxCox Transform}

	transformationFunction <- function(data, theta){
	
						if (theta == 0){
							y <- log(data)
						}
						else{
							y <- (data^theta - 1)/(theta)
						}
						y
					
					}


	BoxCoxTransformation <- function(data){
						
						i <- 1
						n <- length(data)
						theta <- seq(-3.01, 3, 0.001)
	
						thetaVector <- rep(0, length(theta))
						thetaMLEVector <- rep(0, length(theta))
	
						for(thetaValue in theta)
						{
							if(abs(thetaValue) < 1.0e-10){
								thetaValue <- 0
							}
	
							transformedData <- transformationFunction(data, thetaValue)
							varTransformedData <- var(transformedData)
							
							thetaMLE <- (thetaValue - 1) * sum(log(data)) - 
									(n/2) * (log(2*pi*varTransformedData) + 1)
	
							thetaVector[i] <- thetaValue
							thetaMLEVector[i] <- thetaMLE 
	
							i <- i + 1
						}
	
						outputData <- cbind(thetaVector, thetaMLEVector)
	
						#plot(thetaVector, thetaMLEVector, type="l", lab=c(30,50,7))
						
						thetaMLEMax <- max(thetaMLEVector)
						iMax <- which(thetaMLEVector == max(thetaMLEMax))
						thetaMax <- thetaVector[iMax]
	
						cic = thetaMLEMax - .5 * qchisq(.95,1)
						del= .05
	
						iLtci = which(abs(thetaMLEVector - cic)<= del)
	
						iLtciL= min(iLtci)
						iLtciU= max(iLtci)
	
						thLci= thetaVector[iLtciL]
						thUci= thetaVector[iLtciU]
	
						#abline(h=cic)
						#abline(v=thLci)
						#abline(v=thUci)
						#abline(v=thetaMax)
	
						print(paste("theta:", thetaMax, "; 95% Lower CI:", thLci, "; 95% Upper CI:", thUci))
						
						#outputData
						
					}
```

```{r loan_amnt, CACHE = TRUE}
BoxCoxTransformation(loan_amnt)
```

```{r loan_amnt statistics}
plot(density(loan_amnt    , bw = "nrd"))
plot(density(loan_amnt^0.25, bw = "nrd"), col = "red")

hist((loan_amnt)^0.25)
boxplot(loan_amnt ~ loan_status, col = "orange")

lendingClubDataFiltered %>% 
  group_by(loan_status) %>%
  summarise(
                Count = n(), mean = mean(loan_amnt), median = median(loan_amnt), stdDeviation = sd(loan_amnt), min = quantile(loan_amnt)[1]
              , "25%" = quantile(loan_amnt)[2], "50%" = quantile(loan_amnt)[3], "75%" = quantile(loan_amnt)[4], max =  quantile(loan_amnt)[5] 
           )
```


```{r loan_amnt term}
hist(term)

lendingClubDataFiltered %>% 
  group_by(term, loan_status) %>%
  summarise( Count = n() ) %>% 
  mutate(percentage = Count/sum(Count)) %>% 
  dplyr::filter(loan_status == "Charged Off")
```
```{r installment, CACHE = TRUE}
BoxCoxTransformation(installment)
```

```{r installment statistics}
plot(density(installment    , bw = "nrd"))
plot(density(installment^0.25, bw = "nrd"), col = "red")

hist((installment)^0.25)
boxplot(installment ~ loan_status, col = "orange")

lendingClubDataFiltered %>% 
  group_by(loan_status) %>%
  summarise(
                Count = n(), mean = mean(installment), median = median(installment), stdDeviation = sd(installment), min = quantile(installment)[1]
              , "25%" = quantile(installment)[2], "50%" = quantile(installment)[3], "75%" = quantile(installment)[4], max =  quantile(installment)[5] 
           )
```

```{r sub_grade}

  lendingClubDataFiltered %>% 
    group_by(sub_grade, loan_status) %>%
    summarise( Count = n() ) %>% 
    mutate(percentage = Count/sum(Count)) %>% 
    dplyr::filter(loan_status == "Charged Off") %>% 
    ggplot(aes(x= sub_grade ,y = percentage, group = 1) ) +
    geom_line(col ='red')
```

```{r emp_length}

  lendingClubDataFiltered %>% 
    group_by(emp_length, loan_status) %>%
    summarise( Count = n() ) %>% 
    mutate(percentage = Count/sum(Count)) %>% 
    dplyr::filter(loan_status == "Charged Off") %>% 
    ggplot(aes(x= emp_length ,y = percentage, group = 1) ) +
    geom_line(col ='red') + ylim(0, 0.25)
```

```{r home_ownership}

  lendingClubDataFiltered %>% 
    group_by(home_ownership, loan_status) %>%
    summarise( Count = n() ) %>% 
    mutate(percentage = Count/sum(Count)) %>% 
    dplyr::filter(loan_status == "Charged Off") #%>% 
    #ggplot(aes(x= home_ownership ,y = percentage, group = 1) ) +
    #geom_line(col ='red') + ylim(0, 0.25)
```

```{r annual_inc, CACHE = TRUE}
BoxCoxTransformation(annual_inc)
```

```{r loan_amnt statistics}
plot(density(annual_inc    , bw = "nrd"), , xlim = c(min(annual_inc), max(annual_inc)))
plot(density(log(annual_inc), bw = "nrd"), col = "red")

hist(log(annual_inc))
boxplot(log(annual_inc) ~ loan_status, col = "orange")

lendingClubDataFiltered %>% 
  group_by(loan_status) %>%
  summarise(
                Count = n(), mean = mean(log(annual_inc)), median = median(log(annual_inc)), stdDeviation = sd(log(annual_inc))
               , min = quantile(log(annual_inc))[1], "25%" = quantile(log(annual_inc))[2], "50%" = quantile(log(annual_inc))[3]
               , "75%" = quantile(log(annual_inc))[4], max =  quantile(log(annual_inc))[5]
           )
```

```{r purpose}

  lendingClubDataFiltered %>% 
    group_by(purpose, loan_status) %>%
    summarise( Count = n() ) %>% 
    mutate(percentage = Count/sum(Count)) %>% 
    dplyr::filter(loan_status == "Charged Off") %>% 
    arrange(desc(percentage))#%>% 
    #ggplot(aes(x= home_ownership ,y = percentage, group = 1) ) +
    #geom_line(col ='red') + ylim(0, 0.25)
```

```{r addr_state}

  lendingClubDataFiltered %>% 
    group_by(addr_state, loan_status) %>%
    summarise( Count = n() ) %>% 
    mutate(percentage = Count/sum(Count)) %>% 
    dplyr::filter(loan_status == "Charged Off") %>% 
    arrange(desc(percentage))#%>% 
    #ggplot(aes(x= home_ownership ,y = percentage, group = 1) ) +
    #geom_line(col ='red') + ylim(0, 0.25)
```

```{r dti, CACHE = TRUE}
BoxCoxTransformation(dti)
```

```{r dti statistics}
plot(density(dti, bw = "nrd"), col = "red")

hist(dti)
boxplot(dti ~ loan_status, col = "orange")

lendingClubDataFiltered %>% 
  group_by(loan_status) %>%
  summarise(
                Count = n(), mean = mean(dti), median = median(dti), stdDeviation = sd(dti)
               , min = quantile(dti)[1], "25%" = quantile(dti)[2], "50%" = quantile(dti)[3]
               , "75%" = quantile(dti)[4], max =  quantile(dti)[5]
           )
```

```{r addr_state}

  lendingClubDataFiltered %>% 
    group_by(delinq_2yrs, loan_status) %>%
    summarise( Count = n() ) %>% 
    mutate(percentage = Count/sum(Count)) %>% 
    dplyr::filter(loan_status == "Charged Off") %>% 
    arrange(desc(percentage))#%>% 
    #ggplot(aes(x= home_ownership ,y = percentage, group = 1) ) +
    #geom_line(col ='red') + ylim(0, 0.25)
```
 
```{r inq_last_6mths}

  lendingClubDataFiltered %>% 
    group_by(inq_last_6mths, loan_status) %>%
    summarise( Count = n() ) %>% 
    mutate(percentage = Count/sum(Count)) %>% 
    dplyr::filter(loan_status == "Charged Off") %>% 
    arrange(desc(percentage))#%>% 
    #ggplot(aes(x= home_ownership ,y = percentage, group = 1) ) +
    #geom_line(col ='red') + ylim(0, 0.25)
```

```{r open_acc, CACHE = TRUE}
BoxCoxTransformation(open_acc)
```

```{r dti statistics}
plot(density(open_acc, bw = "nrd"), col = "red")
plot(density(open_acc^0.25, bw = "nrd"), col = "red")

hist(open_acc)
hist(open_acc^0.25)
boxplot(open_acc ~ loan_status, col = "orange")

lendingClubDataFiltered %>% 
  group_by(loan_status) %>%
  summarise(
                Count = n(), mean = mean(open_acc), median = median(open_acc), stdDeviation = sd(open_acc)
               , min = quantile(open_acc)[1], "25%" = quantile(open_acc)[2], "50%" = quantile(open_acc)[3]
               , "75%" = quantile(open_acc)[4], max =  quantile(open_acc)[5]
           )
```

```{r pub_rec}
lendingClubDataImputed %>% 
  dplyr::filter(pub_rec != 0) %>% 
  select(loan_amnt, term, grade, sub_grade, emp_length, home_ownership, annual_inc, loan_status, pub_rec, pub_rec_bankruptcies) %>%
  arrange(loan_status) %>%
  group_by(pub_rec, loan_status) %>%
  summarise(count = n()) %>%
  dplyr::filter(loan_status %in% c("Charged Off", "Fully Paid"))

  lendingClubDataFiltered %>% 
    group_by(pub_rec, loan_status) %>%
    summarise( Count = n() ) %>% 
    mutate(percentage = Count/sum(Count)) %>% 
    dplyr::filter(loan_status == "Charged Off") %>% 
    arrange(desc(percentage))#%>% 
    #ggplot(aes(x= home_ownership ,y = percentage, group = 1) ) +
    #geom_line(col ='red') + ylim(0, 0.25)
  
```

```{r revol_bal, CACHE = TRUE}
BoxCoxTransformation(revol_bal)
```

```{r revol_bal statistics}
plot(density(revol_bal, bw = "nrd"), col = "red")
plot(density(log(revol_bal), bw = "nrd"), col = "red")

hist(revol_bal)
hist(log(revol_bal))
boxplot(log(revol_bal) ~ loan_status, col = "orange")

lendingClubDataFiltered %>% 
  group_by(loan_status) %>%
  summarise(
                Count = n(), mean = mean(log(revol_bal + 1)), median = median(log(revol_bal  + 1)), stdDeviation = sd(log(revol_bal + 1))
               , min = quantile(log(revol_bal + 1))[1], "25%" = quantile(log(revol_bal + 1))[2], "50%" = quantile(log(revol_bal + 1))[3]
               , "75%" = quantile(log(revol_bal + 1))[4], max =  quantile(log(revol_bal + 1))[5]
           )
```

```{r revol_util, CACHE = TRUE}
BoxCoxTransformation(revol_util)
```

```{r revol_util statistics}
plot(density(revol_util, bw = "nrd"), col = "red")

hist(revol_util)
boxplot(revol_util ~ loan_status, col = "orange")

lendingClubDataFiltered %>% 
  group_by(loan_status) %>%
  summarise(
                Count = n(), mean = mean(revol_util), median = median(revol_util), stdDeviation = sd(revol_util)
               , min = quantile(revol_util)[1], "25%" = quantile(revol_util)[2], "50%" = quantile(revol_util)[3]
               , "75%" = quantile(revol_util)[4], max =  quantile(revol_util)[5]
           )
```

```{r revol_util, CACHE = TRUE}
BoxCoxTransformation(total_acc)
```

```{r total_acc statistics}
plot(density(total_acc, bw = "nrd"), col = "red")
plot(density(total_acc^0.5, bw = "nrd"), col = "red")

hist(total_acc)
hist(total_acc^0.5)

boxplot(total_acc ~ loan_status, col = "orange")

lendingClubDataFiltered %>% 
  group_by(loan_status) %>%
  summarise(
                Count = n(), mean = mean(total_acc), median = median(total_acc), stdDeviation = sd(total_acc)
               , min = quantile(total_acc)[1], "25%" = quantile(total_acc)[2], "50%" = quantile(total_acc)[3]
               , "75%" = quantile(total_acc)[4], max =  quantile(total_acc)[5]
           )
```

```{r acc_now_delinq}
lendingClubDataImputed %>% 
  dplyr::filter(acc_now_delinq != 0) %>% 
  select(loan_amnt, term, grade, sub_grade, emp_length, home_ownership, loan_status, acc_now_delinq, pub_rec, pub_rec_bankruptcies) %>%
  arrange(loan_status) %>%
  group_by(acc_now_delinq, loan_status) %>%
  summarise(count = n()) %>%
  dplyr::filter(loan_status %in% c("Charged Off", "Fully Paid"))

```
```{r delinq_amnt}
lendingClubDataImputed %>% 
  dplyr::filter(delinq_amnt != 0) %>% 
  select(loan_amnt, term, grade, sub_grade, emp_length, home_ownership, loan_status, delinq_amnt, pub_rec, pub_rec_bankruptcies) %>%
  arrange(loan_status) %>%
  group_by(delinq_amnt, loan_status) %>%
  summarise(count = n()) %>%
  dplyr::filter(loan_status %in% c("Charged Off", "Fully Paid"))
```


```{r pub_rec_bankruptcies}
lendingClubDataImputed %>% 
  dplyr::filter(pub_rec_bankruptcies != 0) %>% 
  #select(loan_amnt, term, grade, sub_grade, emp_length, home_ownership, loan_status, delinq_amnt, pub_rec, pub_rec_bankruptcies) %>%
  arrange(pub_rec_bankruptcies) %>%
  group_by(pub_rec_bankruptcies, loan_status) %>%
  summarise(count = n()) %>%
  dplyr::filter(loan_status %in% c("Charged Off", "Fully Paid"))

  lendingClubDataFiltered %>% 
    group_by(pub_rec_bankruptcies, loan_status) %>%
    summarise( Count = n() ) %>% 
    mutate(percentage = Count/sum(Count)) %>% 
    dplyr::filter(loan_status == "Charged Off") %>% 
    arrange(desc(percentage))#%>% 
    #ggplot(aes(x= home_ownership ,y = percentage, group = 1) ) +
    #geom_line(col ='red') + ylim(0, 0.25)
  
```


```{r tax_liens}
lendingClubDataImputed %>% 
  dplyr::filter(tax_liens != 0) %>% 
  select(loan_amnt, term, grade, sub_grade, emp_length, home_ownership, loan_status, tax_liens, pub_rec, pub_rec_bankruptcies) %>%
  arrange(tax_liens) %>%
  group_by(tax_liens, loan_status) %>%
  summarise(count = n()) %>%
  dplyr::filter(loan_status %in% c("Charged Off", "Fully Paid"))
```

From the above Results, we can remove the following columns:
* acc_now_delinq
* delinq_amnt
* tax_liens

```{r removing feature further}
lendingClubDataImputed <- lendingClubDataImputed %>% dplyr::select(-c(acc_now_delinq, delinq_amnt, tax_liens))
table(sapply(lendingClubDataImputed[1,],class))
```


##### **7. Correlation Filtering **

```{r Correlation Filtering}
numericColumns   <- names(lendingClubDataFiltered) [sapply(lendingClubDataFiltered[1, ], class) == "numeric"]
corrleation      <- cor(lendingClubDataFiltered[, numericColumns], use="pairwise.complete.obs", method="pearson") 
corrplot(corrleation, method='number', type = 'upper', tl.cex=.5)
```

##### **7.Variability Check **

```{r Variability Check preProcess Method}

lendingClubDataFiltered %>%
  preProcess(method = 'zv') %>%
  predict(newdata = lendingClubDataFiltered)

#nzv methods removes the columns with minor non - zero variability

lendingClubDataFiltered %>%
  preProcess(method = 'nzv') %>%
  predict(newdata = lendingClubDataFiltered)

nearZeroVar(lendingClubDataFiltered, saveMetrics = TRUE)
```


##### **5. e. Datatype Conversion **

* 1. Look for quantitative variables that are numeric and convert them into numeric.
* 2. Look for qualitative variables that are numeric and convert them into factors.
* 3. Encode the qualitative variables into dummy variables.



```{r}
lendingClubData %>% dplyr::filter(is.na(last_credit_pull_d)) %>% dplyr::select(member_id, term ,last_credit_pull_d)
lendingClubData %>% dplyr::filter(is.na(issue_d)) %>% dplyr::select(member_id, term ,issue_d)
lendingClubData %>% dplyr::filter(is.na(earliest_cr_line)) %>% dplyr::select(member_id, term ,earliest_cr_line)
lendingClubData %>% dplyr::filter(is.na(mo_sin_old_rev_tl_op)) %>% dplyr::select(member_id, term ,mo_sin_old_il_acct)


```

```{r}
lendingClubData %>% 
  dplyr::filter(is.na(mths_since_last_delinq)) %>%
  summarise(Count = n())
 
lendingClubData %>% 
  dplyr::filter(is.na(mths_since_last_delinq)) %>%
  dplyr::select(
                member_id, loan_amnt, funded_amnt, term, int_rate, grade, sub_grade, home_ownership, annual_inc, loan_status, addr_state, dti, 
                delinq_2yrs, inq_last_6mths, mths_since_last_delinq, mths_since_last_record, open_acc, pub_rec, revol_bal, total_acc, out_prncp,
                total_pymnt, total_rec_prncp, total_rec_int, total_rec_late_fee, recoveries, collection_recovery_fee, collections_12_mths_ex_med,
                mths_since_last_major_derog, policy_code, inq_last_12m, acc_open_past_24mths, avg_cur_bal, chargeoff_within_12_mths, delinq_amnt
                ) %>%
  group_by(loan_status)%>%
  summarise(Count = n())
 
```




```{r Look at the input data}
sapply(lendingClubData, function(X) { length(unique(X))})
anyNA(lendingClubData)
```





##### **5. f. Remove Skewness via. transformations **
 
##### **5. d. Look for Correlation and perform correlation filtering **


#### **6. PCA to identify the most significant features **


